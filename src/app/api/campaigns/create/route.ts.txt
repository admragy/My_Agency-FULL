// Path: src/app/api/campaigns/create/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { supabase } from '@/lib/supabase';
import axios from 'axios';

// مفاتيح الـ Hunter التي ستضاف في Vercel
const GOOGLE_KEY = process.env.GOOGLE_KEY!;
const GOOGLE_CX  = process.env.GOOGLE_CX!;
const SB_KEY     = process.env.SCRAPINGBEE_KEY!;

export async function POST(req: NextRequest) {
  const { name, niche, location, keywords, opener } = await req.json();

  // 1. إدخال الحملة
  const { data: camp, error: campError } = await supabase
    .from('campaigns')
    .insert({ name, niche, location, keywords, opener, status: 'running' })
    .select('id')
    .single();
    
  if (campError) return NextResponse.json({ error: campError.message }, { status: 500 });
  if (!camp || !camp.id) return NextResponse.json({ error: 'Failed to create campaign ID' }, { status: 500 });

  // 2. بحث Google (Hunter Logic)
  const query = `${keywords.join(' | ')} ${location}`;
  const url   = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_KEY}&cx=${GOOGLE_CX}&q=${encodeURIComponent(query)}&num=5&hl=ar`; 
  
  const g     = await axios.get(url);
  const pages = g.data.items || [];

  // 3. Scraping الأرقام
  let phones: string[] = [];
  for (const p of pages) {
    try {
        const html = await axios.post('https://app.scrapingbee.com/api/v1', { url: p.link }, 
        { params: { api_key: SB_KEY }, responseType: 'text' });
        
        // استخراج أرقام الهواتف المصرية (01x)
        const phone_matches = html.data.match(/01[0125]\d{8}/g);
        if (phone_matches) phones.push(...phone_matches);
    } catch (e) {
        console.error(`Scraping failed for ${p.link}`);
    }
  }
  phones = [...new Set(phones)]; // إزالة التكرارات

  // 4. إدخال الأرقام في جدول Leads
  if (phones.length > 0) {
    const rows = phones.map(p => ({ phone_number: p, campaign_id: camp.id, status: 'new' }));
    await supabase.from('leads').insert(rows);
  }

  return NextResponse.json({ campaign_id: camp.id, leads_count: phones.length });
}